#!/usr/bin/env python

import json
import sys
import time
import updater

# Information about me, the prober
my_probe="fb-dm-v0"
my_probe_time=1
probe_id = "facebook-domain"

# Blacklist source info
src = "facebook.com"
tp = "blacklist"

# Get Threat Graph
u = updater.FacebookUpdater(probe=my_probe, probe_time=my_probe_time,
                            probe_id=probe_id)

# Get list of all domains which need to be updated.
domains = u.g.get_unprobed_domains(my_probe)

# Iterate over domains
for domain in domains:

    print domain
    
    try:
        res = u.fb.get_domain_report(domain)

    except Exception, e:
        print e
        sys.exit(1)

    elts = u.facebook_threats_to_elts(domain, res["data"])

    # Execute Gaffer insert
    url = "/rest/v2/graph/operations/execute"
    data = json.dumps(elts)
    response = u.g.post(url, data)

    # If status code is bad, fail
    if response.status_code != 200:
        print response.text

    time.sleep(0.01)

